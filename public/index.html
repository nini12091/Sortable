<!DOCTYPE html>
<html>
<head>
	<title>Sortable</title>

	<!-- meta -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<!-- stylesheet -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

	<style>
		th {
			background-color: #4d4d4d;
			font-size: 1em;
			font-weight: normal;
			color: white;
		}

		th:hover {
			opacity: 0.9;
		}

		td {
			font-size: 0.7em;
		}

		/* 셀이 hovering 되었을 때의 클래스입니다 */
		.cell-hover {
			background-color: #f2f2f2;
		}

		/* Ascending, Descending 정렬 버튼을 위한 클래스입니다 */
		.cell-sort {
			margin-left: 0.2em;
		}

		/* 텍스트 드래그 방지를 위한 클래스입니다 */
		.noselect {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
			-o-user-select: none;
			user-select: none;    
		}

		.background {
			fill: none;
			stroke: lightgray;
		}

		.foreground {
			fill: none;
			stroke: steelblue;
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- header -->
		<h1 class="display-5 my-3 py-3">Sortable</h1>

		<!-- control buttons -->
		<button type="button" onclick="reset_select()">Reset select</button>
		<button type="button" onclick="reset_sort()">Reset sort</button>

		<!-- parallel coordinates -->
		<svg width="960" height="540"></svg>

		<!-- sort buttons -->
		<form class="mt-3">
			<label><input type="radio" value="sort_relative" name="mode" checked> Sort_relative </label>
			<label><input type="radio" value="sort_parallel" name="mode"> Sort_parallel </label>
		</form>

		<!-- sortable -->
		<table id="sortable" class="sortable table table-bordered table-sm"></table>
	</div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script type="text/javascript">

var table = d3.select("#sortable");

var thead = table.append("thead");
var tbody = table.append("tbody");

var origin_data = [];
var data = [];
var headers = [];

var sort = sort_relative;

// initialize sort buttons
d3.selectAll("input[name='mode']")
	.data([sort_relative, sort_parallel])
	.on("change", function(d){
		sort = d;
	});

// Load data from assets
d3.csv("data.csv").then(function(_data){
	origin_data = _data.map(function(d){ return d; });
	data = _data;

	// pick headers
	headers = d3.keys(data[0]);

	// parse as number
	data.forEach(function(d){
		d3.keys(d).forEach(function(field){
			if(field !== "name") d[field] = +d[field];
		})
	});

	// formatting data
	data.forEach(function(d, i){
		d3.keys(d).forEach(function(field){
			d[field] = { id: i, value: d[field] };
		});
	});

	// plot
	parallelTable();
	parallelCoordinates();
});

function parallelTable(){
	thead.append("tr")
		.selectAll("th")
		.data(headers.map(function(d){ return {field: d, ascending: true}; }))
	.enter().append("th")
		.attr("class", "noselect")
		.style("text-align", function(d, i){ return i == 0 ? "left" : "center"; })
		.text(function(d){ return d.field; })
		.on("click", function(d){
			// toggle ascend/descend
			d.ascending = !d.ascending;

			sort(d.field, d.ascending);
		})
	.append("i")
		.style("font-weight", "bolder")
		.attr("class", "cell-sort fa fa-angle-up");

	console.log(data);

	display();
}

function reset_select(){
	d3.selectAll(".cell-active")
		.style("background-color", null)
		.each(function(d){ delete d.color; })
		.classed("cell-active", false);

	reset_brush();
}

function reset_sort(){
	sort_relative(d3.keys(data[0])[0], true);
}

function sort_relative(field, ascending = true){
	var related = {};
	data.forEach(function(d){
		d3.keys(d).forEach(function(field){
			var id = d[field].id;
			if(!(id in related)){
				related[id] = {};
				headers.forEach(function(field){ related[id][field] = null; });
			}
			related[id][field] = d[field];
		});
	});
	data = d3.values(related).sort(function(a, b){
		return (a[field].value > b[field].value ? true : a[field].value < b[field].value ? false : a[field].id > b[field].id) ^ ascending ? -1 : 1;
	});

	// process sort buttons (toggle status)
	d3.selectAll(".cell-sort").attr("class", function(d){
		if(d.field == field){
			return "cell-sort fa fa-angle-" + (ascending ? "up" : "down") + " text-success";
		}
		d.ascending = true;
		return "cell-sort fa fa-angle-up";
	});

	display();
}

function sort_parallel(field, ascending = true){
	data.map(function(d){
		// pick field
		return d[field];
	}).sort(function(a, b){
		// sort
		return (a.value > b.value ? true : a.value < b.value ? false : a.id > b.id) ^ ascending ? -1 : 1;
	}).forEach(function(d, i){
		data[i][field] = d;
	});

	d3.selectAll(".cell-sort").select(function(d){
		return d.field == field ? this : null;
	}).attr("class", function(d){
		return "cell-sort fa fa-angle-" + (ascending ? "up" : "down") + " text-success";
	});

	display();
}

function display(){
	var rows = tbody.selectAll("tr")
		.data(data);

	rows.exit().remove();

	rows.enter().append("tr")
		.selectAll("td")
		.data(function(d){ return d3.values(d); })
	.enter().append("td")
		.style("text-align", function(d, i){ return i == 0 ? "left" : "center"; })
		.on("mouseover", function(d){
			d3.selectAll(".cell-" + d.id)
				.classed("cell-hover", true);
		})
		.on("mouseout", function(d){
			d3.selectAll(".cell-" + d.id)
				.classed("cell-hover", false);
		})
		.on("click", function(d){
			var cell = d3.selectAll(".cell-" + d.id);
			var isActive = !cell.classed("cell-active");
			cell.classed("cell-active", isActive)
				.each(function(d){ d.color = isActive ? d3.interpolateSinebow(d.id / data.length) : null; })
				.style("background-color", function(d){ return d.color; });
		});
	
	tbody.selectAll("tr")
		.selectAll("td")
		.data(function(d){ return d3.values(d); })
		.attr("class", function(d){ return "cell-" + d.id; })
		.classed("cell-active", function(d){ return d.color; })
		.style("background-color", function(d){ return d.color; })
		.text(function(d){ return d.value; });
}

/**
 * Parallel Coordinates
 */
function parallelCoordinates(){
	var margin = {top: 40, right: 10, bottom: 20, left: 20};
	var width = d3.select("svg").attr("width") - margin.left - margin.right;
	var height = d3.select("svg").attr("height") - margin.top - margin.bottom;

	var svg = d3.select("svg")
		.selectAll("svg")
		.data([margin])
	.enter().append("g")
		.attr("width", function(d){})
		.attr("transform", function(d){ return "translate(" + d.left + "," + d.top + ")"; });

	// remove name field
	var dimensions = headers
		.filter(function(field){ return field != "name"; });

	var x = d3.scaleBand()
		.domain(dimensions)
		.range([0, width]);
	var y = {};

	dimensions.forEach(function(field){
		y[field] = d3.scaleLinear()
			.domain(d3.extent(data, function(d){ return +d[field].value; }))
			.range([height, 0])
			.nice();
	});

	var line = d3.line();
	var path = function(d){
		return line(dimensions.map(function(field){ return [x(field), y[field](d[field].value)]; }));
	};
	var axis = d3.axisLeft();

	var background = svg.append("g")
			.attr("class", "background")
		.selectAll("path")
			.data(data)
		.enter().append("path")
			.attr("d", path);

	var foreground = svg.append("g")
			.attr("class", "foreground")
		.selectAll("path")
			.data(data)
		.enter().append("path")
			.attr("d", path);

	var g = svg.selectAll(".dimension")
			.data(dimensions)
		.enter().append("g")
			.attr("class", "dimension")
			.attr("transform", function(d){ return "translate(" + x(d) + ")"; });

	g.append("g")
			.attr("class", "axis")
			.each(function(field){ d3.select(this).call(axis.scale(y[field])); })
		.append("text")
			.style("text-anchor", "middle")
			.style("font-size", "1.5em")
			.attr("fill", "black")
			.attr("y", -9)
			.text(function(field){ return field; });

	var brush = function(field){
		return function(){
			y[field].selection = d3.event.selection;
			var actives = dimensions.filter(function(field){ return y[field].selection; });

			var visible = {};
			foreground.style("display", function(d){
				return visible[d[dimensions[0]].id] = actives.every(function(field, i){
					return y[field].selection[0] <= y[field](d[field].value) && y[field](d[field].value) <= y[field].selection[1];
				}) ? null : "none";
			});

			// process table data
			var parallelData = {};
			headers.forEach(function(field){
				parallelData[field] = [];
			});
			origin_data.forEach(function(d){
				headers.forEach(function(field){
					if(visible[d[field].id] != "none") parallelData[field].push(d[field]);
				});
			});

			data = [];
			while(parallelData[field].length > 0){
				var d = {};
				headers.forEach(function(field){
					d[field] = parallelData[field].shift();
				});
				data.push(d);
			}

			// plot data
			display(data);
		};
	};

	var brushG = g.append("g")
			.attr("class", "brush")
			.each(function(field){ d3.select(this).call(y[field].brush = d3.brushY().extent([[-8, 0], [8, height]]).on("brush", brush(field))); });

	window.reset_brush = function(){
		brushG.each(function(field){
			d3.select(this).call(y[field].brush.move, null);
		});
	}

}

</script>
</html>