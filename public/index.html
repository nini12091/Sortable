<!DOCTYPE html>
<html>
<head>
	<title>Sortable</title>

	<!-- meta -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<!-- stylesheet -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<style>
		th {
			background-color: #4d4d4d;
			font-size: 1em;
			font-weight: normal;
			color: white;
		}

		.cell {
			text-align: center;
		}

		.cell > rect {
			fill: white;
			stroke: lightgray;
			stroke-width: 1px;
		}

		.cell > text {
			fill: black;
			font-size: 0.7em;
			white-space: nowrap;
			text-overflow: clip;
			text-anchor: middle;
			alignment-baseline: central;
		}

		/* 셀이 hovering 되었을 때의 클래스입니다 */
		.cell-hover > rect {
			fill: #f2f2f2;
		}

		/* Ascending, Descending 정렬 버튼을 위한 클래스입니다 */
		.cell-sort {
			margin-left: 0.2em;
		}

		/* 셀이 클릭되었을 때의 클래스입니다 */
		.cell-active {
			color: white;
		}

		/* PC에서 line이 hovering되었을 때의 클래스입니다 */
		.line-hover {
			stroke-width: 2;
		}

		/* PC에서 line이 클릭되었을 때의 클래스입니다 */
		.line-active {
			stroke-width: 3;
		}

		/* 텍스트 드래그 방지를 위한 클래스입니다 */
		.noselect {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
			-o-user-select: none;
			user-select: none;    
		}

		.background {
			fill: none;
			stroke: lightgray;
		}

		.foreground {
			fill: none;
			stroke: steelblue;
		}

		.controller-btn {
			color: #f2f2f2;
			fill: #333;
			opacity: 0.9;
			text-align: center;
			padding: 8px;
		}

		.controller-btn > rect{
			stroke: white;
		}

		.controller-btn > text{
			fill: white;
			text-anchor: middle;
			alignment-baseline: central;
		}

		.controller-btn:hover {
			opacity: 1;
		}
	</style>
</head>
<body>
	<div class="container-fluid">
		<!-- header -->
		<h1 class="display-5 my-3 py-3">Sortable</h1>

		<!-- control buttons -->
		<button type="button" onclick="Data.reset()">Reset</button>

		<!-- sort buttons -->
		<!-- <form class="mt-3">
			<label><input id="sort-relative" type="radio" value="sortRelative" name="mode" checked> Sort relative </label>
			<label><input id="sort-parallel" type="radio" value="sortParallel" name="mode"> Sort parallel </label>
		</form> -->

		<div id="controller"></div>

		<div id="layout">
			<!-- parallel coordinates -->
			<div id="pc" class="noselect"></div>

			<!-- sortable -->
			<div id="sortable"></div>
		</div>
	</div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="Data.js"></script>
<script src="Table.js"></script>
<script src="PC.js"></script>
<script type="text/javascript">

function Controller(options){
	var bindto = options.bindto;
	var data = options.data;
	var height = options.height || 40;

	this.el.root = d3.select(bindto).append("svg");
	this.data = data;
	this._height = height;

	d3.select(this.el.root.node().parentNode)
			.attr("class", "controller position-sticky sticky-top mx-auto noselect");

	this.el.headers = this.el.root.selectAll("g")
			.data(this.data.headers)
		.enter().append("g")
			.attr("class", "controller-btn")
			.on("click", (header) => {
				this.data.sort(header, 
					header.order === this.data.ascend ? this.data.descend
					: header.order === this.data.descend ? this.data.ascend
					: this.data.ascend);
			});

	this.el.headers.append("rect");

	this.el.texts = this.el.headers.append("text")
			.attr("class", "header-text")
			.text(function(header){ return header.name; });

	this.el.sorts = this.el.headers.append("text")
			.attr("class", "header-icon")
			.attr("font-family", "FontAwesome")
			.attr("text-anchor", "end")
			.attr("dominant-baseline", "central");

	this.updateSize();

	this.data.on("sort.controller", (...args) => this.onSort(...args));
}

Controller.prototype.el = {};

Controller.prototype.onSort = function(sort, header, order){
	this.el.sorts.text((header) => {
		return header.order === this.data.ascend ? "\uf106"
		: header.order === this.data.descend ? "\uf107"
		: "";
	});
}

Controller.prototype.width = function(width){
	if(width){
		this._width = width;
		this.updateSize();
	}
	else return this._width;
}

Controller.prototype.height = function(height){
	if(height){
		this._height = height;
		this.updateSize();
	}
	else return this._height;
}

Controller.prototype.updateSize = function(){
	var width = this._width, height = this._height;
	if(width === undefined || height === undefined) return;

	this.el.root
		.attr("width", width)
		.attr("height", height);

	var nestedWidth = 0;
	var length = this.data.headers.length;
	this.el.headers
		.each(function(header){
			d3.select(this)
				.attr("transform", "translate(" + nestedWidth + ")")
				.select("rect")
					.attr("height", height)
					.attr("width", (header) => {
						header.x = nestedWidth;
						header.width = (header.weight / length) * width
						nestedWidth += header.width;
						return header.width;
					});
		});

	this.el.texts
		.attr("x", function(header){
			return header.width / 2;
		})
		.attr("y", height / 2);

	this.el.sorts
		.attr("x", function(header){
			return header.width - 12;
		})
		.attr("y", height / 2);
}

function Container(options){
	var bindto = options.bindto;
	var data = options.data;

	this.el.root = d3.select(bindto);
	this.data = data;

	this.controllers.headers = new Controller({
		bindto: "#controller",
		data: this.data
	});

	// default
	this.resize = this.vertical;
	this.resize();

	// handle window resize
	d3.select(window).on("resize", () => {
		this.resize();
	});
}

Container.prototype.el = {};
Container.prototype.childrens = [];
Container.prototype.controllers = {};

Container.prototype.horizontal = function(){
	this.el.root.attr("class", "row");
	d3.values(this.controllers).forEach((controller) => {
		this.updateSize(controller);
	});
	this.childrens.forEach((children) => {
		d3.select(children.el.root.node().parentNode).attr("class", "col-6");
		this.updateSize(children);
	});
	this.resize = this.horizontal;
}

Container.prototype.vertical = function(){
	this.el.root.attr("class", "row");
	d3.values(this.controllers).forEach((controller) => {
		this.updateSize(controller);
	});
	this.childrens.forEach((children) => {
		d3.select(children.el.root.node().parentNode).attr("class", "col-12");
		this.updateSize(children);
	});
	this.resize = this.vertical;
}

Container.prototype.addChildren = function(children){
	// this.el.root.append("div").append(function(){
	// 	return children.el.root.remove().node();
	// });
	this.childrens.push(children);

	this.resize();
}

Container.prototype.updateSize = function(children){
	var childrect = children.el.root.node().parentNode.getBoundingClientRect();
	children.width(childrect.width);
}

var container;
var table, pc;
var data;

// Load data from assets
d3.csv("data.csv").then(function(_data){
	data = new Data(_data);

	// plot
	container = new Container({
		bindto: "#layout",
		data: data
	});
	table = new Table({
		bindto: "#sortable",
		data: data
	});
	pc = new PC({
		bindto: "#pc",
		data: data
	});

	container.addChildren(pc);
	container.addChildren(table);
});

</script>
</html>