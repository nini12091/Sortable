<!DOCTYPE html>
<html>
<head>
	<title>Sortable</title>

	<!-- meta -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<!-- stylesheet -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<style>
		th {
			background-color: #4d4d4d;
			font-size: 1em;
			font-weight: normal;
			color: white;
		}

		th:hover {
			opacity: 0.9;
		}

		td {
			font-size: 0.7em;
		}

		/* 셀이 hovering 되었을 때의 클래스입니다 */
		.cell-hover {
			background-color: #f2f2f2;
		}

		/* Ascending, Descending 정렬 버튼을 위한 클래스입니다 */
		.cell-sort {
			margin-left: 0.2em;
		}

		/* 텍스트 드래그 방지를 위한 클래스입니다 */
		.noselect {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
			-o-user-select: none;
			user-select: none;    
		}

		.background {
			fill: none;
			stroke: lightgray;
		}

		.foreground {
			fill: none;
			stroke: steelblue;
		}
	</style>
</head>
<body>
	<div id="layout">
		<!-- header -->
		<h1 class="display-5 my-3 py-3">Sortable</h1>

		<!-- control buttons -->
		<button type="button" onclick="Data.reset()">Reset</button>

		<!-- parallel coordinates -->
		<svg id="pc" width="960" height="540"></svg>

		<!-- sort buttons -->
		<form class="mt-3">
			<label><input id="sort-relative" type="radio" value="sortRelative" name="mode" checked> Sort relative </label>
			<label><input id="sort-parallel" type="radio" value="sortParallel" name="mode"> Sort parallel </label>
		</form>

		<!-- sortable -->
		<table id="sortable" class="sortable table table-bordered table-sm">
			<thead>
				<tr></tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script type="text/javascript">

const Control = {};
Control.reset = function(){
	// reset filtered data first
	PC.reset();

	d3.selectAll(".cell-active")
		.style("background-color", null)
		.each(function(d){
			d.active = false;
			d.color = null;
		})
		.classed("cell-active", false);

	table.sort = Control.sortRelative;
	table.sort(d3.keys(Data.origin[0])[0], true); // sort by first field "name"
};

const Data = {};
Data.headers = [];
Data.origin = [];
Data.current = []; // filtered data
Data.reset = function(){
	Data.current = Data.origin.map(function(d){ return d; });
};
Data.ascend = function(a, b){
	return (a.value > b.value ? true : a.value < b.value ? false : a.id > b.id) ^ true ? -1 : 1;
};
Data.descend = function(a, b){
	return (a.value > b.value ? true : a.value < b.value ? false : a.id > b.id) ^ false ? -1 : 1;
};
Data.sortRelative = function(field, order){
	var related = {};
	Data.current.forEach(function(d){
		d3.keys(d).forEach(function(field){
			var id = d[field].id;
			if(!(id in related)){
				related[id] = {};
				Data.headers.forEach(function(field){ related[id][field] = null; });
			}
			related[id][field] = d[field];
		});
	});
	Data.current = d3.values(related).sort(function(a, b){ return order(a[field], b[field]); });
};
Data.sortParallel = function(field, order){
	Data.current.map(function(d){
		// pick field
		return d[field];
	}).sort(order).forEach(function(d, i){
		Data.current[i][field] = d;
	});

	d3.selectAll(".cell-sort").select(function(d){
		return d.field == field ? this : null;
	}).attr("class", function(d){
		return "cell-sort fa fa-angle-" + (ascending ? "up" : "down") + " text-success";
	});
};
Data.sort = Data.sortRelative;

// initialize sort buttons
d3.select("#sort-relative").on("change", function(){ Data.sort = Data.sortRelative; });
d3.select("#sort-parallel").on("change", function(){ Data.sort = Data.sortParallel; });

var table, pc;

// Load data from assets
d3.csv("data.csv").then(function(data){

	// store to global variable
	Data.origin = data.map(function(d){ return d; });
	Data.current = data;

	// pick headers from first record
	Data.headers = d3.keys(data[0]);

	// parse as number
	data.forEach(function(d){
		d3.keys(d).forEach(function(field){
			if(field !== "name") d[field] = +d[field];
		});
	});

	Data.headerId = {};
	Data.headers.forEach(function(field){ Data.headerId[field] = Data.headers.indexOf(field); });

	// formatting cell
	data.forEach(function(d, i){
		d3.keys(d).forEach(function(field){
			d[field] = {
				id: i,
				field: field,
				col: Data.headerId[field],
				value: d[field],
				visible: true,
				active: false,
				color: null
			};
		});
	});

	// plot
	table = new Table("#sortable");
	pc = new PC("#pc");
});


function Table(table){
	this.el.table = d3.select(table);
	this.el.head = this.el.table.select("thead");
	this.el.body = this.el.table.select("tbody");

	this.el.head.select("tr")
		.selectAll("th")
			.data(Data.headers.map(function(field){ return {
				field: field,
				col: Data.headerId[field],
				ascending: true
			}; }))
		.enter().append("th");

	this.el.head.select("tr")
		.selectAll("th")
			// .data(function(field){ return { field: field, col: Data.headerId[field], ascending: true }; })
			.attr("class", function(d){ return "header header-col-" + d.col + " noselect"; })
			.style("text-align", function(d, i){ return i == 0 ? "left" : "center"; }) // align center except first field "name"
			.text(function(d){ return d.field; })
			.on("mouseover", function(d){
				d3.selectAll(".cell-col-" + d.col).classed("cell-hover", true);
			})
			.on("mouseout", function(d){
				d3.selectAll(".cell-col-" + d.col).classed("cell-hover", false);
			})
			.on("click", (d) => {
				// toggle ascend or descend
				d.ascending = !d.ascending;
				Data.sort(d.field, d.ascending ? Data.ascend : Data.descend);

				// process sort buttons (toggle status)
				var field = d.field, ascending = d.ascending;
				d3.selectAll(".cell-sort").attr("class", function(d){
					if(d.field == field){
						return "cell-sort fa fa-angle-" + (ascending ? "up" : "down") + " text-success";
					}
					d.ascending = true;
					return "cell-sort fa fa-angle-up";
				});
			})
		.append("i")
			.style("font-weight", "bolder")
			.attr("class", "cell-sort fa fa-angle-up");

	var rows = this.el.body.selectAll("tr")
		.data(Data.current);

	rows.exit().remove();

	rows.enter().append("tr")
			.selectAll("td")
			.data(function(d){ return d3.values(d); })
		.enter().append("td")
			.style("text-align", function(d, i){ return i == 0 ? "left" : "center"; })
			.on("mouseover", function(d){
				d3.selectAll(".cell-row-" + d.id).classed("cell-hover", true);
			})
			.on("mouseout", function(d){
				d3.selectAll(".cell-row-" + d.id).classed("cell-hover", false);
			})
			.on("click", function(d){
				var active = d.active = !d.active;
				d3.selectAll(".cell-row-" + d.id)
					.classed("cell-active", d.active)
					.each(function(d){ d.color = (d.active = active) ? d3.interpolateSinebow(d.id / Data.origin.length) : null; })
					.style("background-color", function(d){ return d.color; });
			});

	this.el.body.selectAll("tr")
		.selectAll("td")
		.data(function(d){ return Data.headers.map(function(field){ return d[field]; }); })
		.attr("class", function(d){ return "cell-col-" + d.col + " cell-row-" + d.id; })
		.classed("cell-active", function(d){ return d.active; })
		.style("background-color", function(d){ return d.color; })
		.text(function(d){ return d.value; });
}

Table.prototype.el = {};

Table.prototype.headers = function(headers){
	if(headers) this._headers = headers;
	else return this._headers;
}

Table.prototype.width = function(width){
	if(width) this._width = width - this.margin.left - this.margin.right;
	else return this._width;
}

Table.prototype.height = function(height){
	if(height) this._height = height - this.margin.top - this.margin.bottom;
	else return this._height;
}

// Parallel Coordinates
function PC(svg){
	this.el.svg = d3.select(svg);

	this.width(this.el.svg.attr("width"));
	this.height(this.el.svg.attr("height"));

	this.el.g = this.el.svg.append("g").attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

	this.headers = Data.headers.filter(function(field, i){ return i != 0; }); // except first field "name"

	this.x = d3.scaleBand().domain(this.headers).range([0, this.width()]);
	this.y = {};

	this.headers.forEach((field) => {
		this.y[field] = d3.scaleLinear()
			.domain(d3.extent(Data.origin, function(d){ return +d[field].value; }))
			.range([this.height(), 0])
			.nice();
	});

	this.el.background = this.el.g.append("g")
			.attr("class", "background")
			.selectAll("path")
			.data(Data.origin)
		.enter().append("path");

	this.el.foreground = this.el.g.append("g")
			.attr("class", "foreground")
			.selectAll("path")
			.data(Data.origin)
		.enter().append("path");

	var _this = this;
	this.el.axis = this.el.g.selectAll(".header")
			.data(this.headers)
		.enter().append("g")
			.attr("class", "header")
			.call(d3.drag()
				.subject(() => { return d3.select(this); })
				.on("start", (field) => {
					this.dragging[field] = this.x(field);
					this.el.background.attr("visibility", "hidden");
				})
				.on("drag", (field) => {
					this.dragging[field] = Math.min(this.width(), Math.max(-1, d3.event.x));
					this.el.foreground.attr("d", (d) => this.path(d));

					// Update headers order
					Data.headers = [Data.headers[0]].concat(this.headers.sort((a, b) => { return this.position(a) - this.position(b); }));

					this.x.domain(this.headers);
					this.el.axis.attr("transform", (field) => { return "translate(" + this.position(field) + ")"; });
				})
				.on("end", function(field){
					delete _this.dragging[field];
					d3.select(this).transition().attr("transform", "translate(" + _this.x(field) + ")");
					_this.el.foreground.transition().attr("d", (d) => _this.path(d));
					_this.el.background
							.attr("d", (d) => _this.path(d))
						.transition()
							.delay(500)
							.duration(0)
							.attr("visibility", null);
				}));

	this.el.axis.append("g")
			.attr("class", "axis")
			.each(function(field){ d3.select(this).call(_this.axis.scale(_this.y[field])); })
		.append("text")
			.style("text-anchor", "middle")
			.style("font-size", "1.5em")
			.attr("fill", "black")
			.attr("y", -9)
			.text(function(field){ return field; });

	this.el.brush = this.el.axis.append("g")
		.attr("class", "brush")
		.each(function(field){
			d3.select(this)
				.call(_this.y[field].brush = d3.brushY().extent([[-12, 0], [12, _this.height()]]).on("brush", _this.brush(field)));
		});

	this.updateLines();
}

PC.prototype.el = {};

PC.prototype.margin = { top: 40, right: 10, bottom: 20, left: 20 };

PC.prototype.width = function(width){
	if(width) this._width = width;
	else return this._width;
}

PC.prototype.height = function(height){
	if(height) this._height = height;
	else return this._height;
}

PC.prototype.dragging = {}; // currently dragging axis

PC.prototype.axis = d3.axisLeft();

PC.prototype.line = d3.line();

PC.prototype.path = function(d){
	return this.line(this.headers.map((field) => {
		return [this.position(field), this.y[field](d[field].value)];
	}));
}

// position contains dragging
PC.prototype.position = function(field){
	return field in this.dragging ? this.dragging[field] : this.x(field);
}

PC.prototype.updateLines = function(){
	this.el.background.attr("d", (d) => this.path(d));
	this.el.foreground.attr("d", (d) => this.path(d));

	this.el.axis.attr("transform", (d) => { return "translate(" + this.x(d) + ")"; });
}

PC.prototype.brush = function(field){
	return () => {
		this.y[field].selection = d3.event.selection;
		var actives = this.headers.filter((field) => { return this.y[field].selection; });

		var visible = {};
		this.el.foreground.style("display", (d) => {
			return visible[d[this.headers[0]].id] = actives.every((field, i) => {
				return this.y[field].selection[0] <= this.y[field](d[field].value) && this.y[field](d[field].value) <= this.y[field].selection[1];
			}) ? null : "none";
		});

		// process table data
		var parallelData = {};
		Data.headers.forEach(function(field){
			parallelData[field] = [];
		});
		Data.origin.forEach(function(d){
			Data.headers.forEach(function(field){
				if(visible[d[field].id] != "none") parallelData[field].push(d[field]);
			});
		});

		Data.current = [];
		while(parallelData[field].length > 0){
			var d = {};
			Data.headers.forEach(function(field){
				d[field] = parallelData[field].shift();
			});
			Data.current.push(d);
		}
	};
}

PC.prototype.reset = function(){
	var _this = this;
	this.el.brush.each(function(field){
		d3.select(this).call(_this.y[field].brush.move, null);
	});
}

</script>
</html>